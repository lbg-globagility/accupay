USE goldwingspayrolldb_currdata;

SET @e_num = 269;

SET @og_id = 3;

SET @et_datefrom = '2017-01-21';
SET @et_dateto = '2017-02-05';
	
	SELECT eot.*
	
	,CONCAT_DATETIME(eot.OTStartDate, og.NightDifferentialTimeFrom) `NDiffEndTimeStamp`
	,CONCAT_DATETIME(ADDDATE(eot.OTStartDate, INTERVAL 1 DAY), og.NightDifferentialTimeTo) `NDiffEndTimeStamp`
	
	,CONCAT(TIME_FORMAT(eot.OTStartTime,'%p'), TIME_FORMAT(eot.OTEndTime,'%p')) `TimeCombi`
	
	FROM employeeovertime eot
	INNER JOIN employee e ON e.RowID=eot.EmployeeID AND e.EmployeeID=@e_num
	INNER JOIN organization og
			ON og.RowID=eot.OrganizationID
			AND CONCAT_DATETIME(eot.OTStartDate, eot.OTStartTime) >= CONCAT_DATETIME(eot.OTStartDate, og.NightDifferentialTimeFrom)
	WHERE eot.OrganizationID=@og_id
	AND TIME_FORMAT(eot.OTStartTime,'%p') = 'PM'
	AND TIME_FORMAT(eot.OTStartTime,'%p') = TIME_FORMAT(eot.OTEndTime,'%p')
UNION
	
	SELECT eot.*
	
	,CONCAT_DATETIME(eot.OTStartDate, og.NightDifferentialTimeFrom) `NDiffEndTimeStamp`
	,CONCAT_DATETIME(ADDDATE(eot.OTStartDate, INTERVAL 1 DAY), og.NightDifferentialTimeTo) `NDiffEndTimeStamp`
	
	,CONCAT(TIME_FORMAT(eot.OTStartTime,'%p'), TIME_FORMAT(eot.OTEndTime,'%p')) `TimeCombi`
	
	FROM employeeovertime eot
	INNER JOIN employee e ON e.RowID=eot.EmployeeID AND e.EmployeeID=@e_num
	INNER JOIN organization og
			ON og.RowID=eot.OrganizationID
			AND CONCAT_DATETIME(eot.OTEndDate, eot.OTEndTime) <= CONCAT_DATETIME(ADDDATE(eot.OTStartDate, INTERVAL 1 DAY), og.NightDifferentialTimeTo)
	WHERE eot.OrganizationID=@og_id
	AND TIME_FORMAT(eot.OTStartTime,'%p') = 'AM'
	AND TIME_FORMAT(eot.OTStartTime,'%p') = TIME_FORMAT(eot.OTEndTime,'%p')

